<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Template.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="sop.Ajax.html">Ajax</a><ul class='methods'><li data-type='method'><a href="sop.Ajax.html#.abort">abort</a></li><li data-type='method'><a href="sop.Ajax.html#.add">add</a></li><li data-type='method'><a href="sop.Ajax.html#.all">all</a></li><li data-type='method'><a href="sop.Ajax.html#.clear">clear</a></li><li data-type='method'><a href="sop.Ajax.html#.count">count</a></li><li data-type='method'><a href="sop.Ajax.html#.create">create</a></li><li data-type='method'><a href="sop.Ajax.html#.remove">remove</a></li><li data-type='method'><a href="sop.Ajax.html#abort">abort</a></li><li data-type='method'><a href="sop.Ajax.html#isStopped">isStopped</a></li><li data-type='method'><a href="sop.Ajax.html#send">send</a></li></ul></li><li><a href="sop.Application.html">Application</a><ul class='methods'><li data-type='method'><a href="sop.Application.html#dispatch">dispatch</a></li><li data-type='method'><a href="sop.Application.html#getCurrentRoute">getCurrentRoute</a></li><li data-type='method'><a href="sop.Application.html#registerStage">registerStage</a></li><li data-type='method'><a href="sop.Application.html#run">run</a></li></ul></li><li><a href="sop.Message.html">Message</a><ul class='methods'><li data-type='method'><a href="sop.Message.html#.fromHash">fromHash</a></li><li data-type='method'><a href="sop.Message.html#send">send</a></li></ul></li><li><a href="sop.Observable.html">Observable</a><ul class='methods'><li data-type='method'><a href="sop.Observable.html#fire">fire</a></li><li data-type='method'><a href="sop.Observable.html#getListeners">getListeners</a></li><li data-type='method'><a href="sop.Observable.html#hasEvent">hasEvent</a></li><li data-type='method'><a href="sop.Observable.html#off">off</a></li><li data-type='method'><a href="sop.Observable.html#on">on</a></li><li data-type='method'><a href="sop.Observable.html#registerEvents">registerEvents</a></li></ul></li><li><a href="sop.Stage.html">Stage</a><ul class='methods'><li data-type='method'><a href="sop.Stage.html#addAutoAbortTask">addAutoAbortTask</a></li><li data-type='method'><a href="sop.Stage.html#getMessage">getMessage</a></li><li data-type='method'><a href="sop.Stage.html#init">init</a></li><li data-type='method'><a href="sop.Stage.html#render">render</a></li></ul></li><li><a href="sop.Template.html">Template</a><ul class='methods'><li data-type='method'><a href="sop.Template.html#getCTpl">getCTpl</a></li></ul></li><li><a href="sop.Template.CTpl.html">CTpl</a><ul class='methods'><li data-type='method'><a href="sop.Template.CTpl.html#render">render</a></li></ul></li><li><a href="sop.Url.html">Url</a><ul class='methods'><li data-type='method'><a href="sop.Url.html#.parse">parse</a></li><li data-type='method'><a href="sop.Url.html#.parseHash">parseHash</a></li><li data-type='method'><a href="sop.Url.html#.parseSearch">parseSearch</a></li><li data-type='method'><a href="sop.Url.html#toString">toString</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="sop.html">sop</a><ul class='methods'><li data-type='method'><a href="sop.html#.aRemove">aRemove</a></li><li data-type='method'><a href="sop.html#.assertEmpty">assertEmpty</a></li><li data-type='method'><a href="sop.html#.extend">extend</a></li><li data-type='method'><a href="sop.html#.extendProto">extendProto</a></li><li data-type='method'><a href="sop.html#.fDelay">fDelay</a></li><li data-type='method'><a href="sop.html#.generateId">generateId</a></li><li data-type='method'><a href="sop.html#.getValueByPath">getValueByPath</a></li><li data-type='method'><a href="sop.html#.isArray">isArray</a></li><li data-type='method'><a href="sop.html#.isBoolean">isBoolean</a></li><li data-type='method'><a href="sop.html#.isElement">isElement</a></li><li data-type='method'><a href="sop.html#.isFunction">isFunction</a></li><li data-type='method'><a href="sop.html#.isNumber">isNumber</a></li><li data-type='method'><a href="sop.html#.isNumeric">isNumeric</a></li><li data-type='method'><a href="sop.html#.isObject">isObject</a></li><li data-type='method'><a href="sop.html#.isObjectLike">isObjectLike</a></li><li data-type='method'><a href="sop.html#.isString">isString</a></li><li data-type='method'><a href="sop.html#.isUndefined">isUndefined</a></li><li data-type='method'><a href="sop.html#.oEvery">oEvery</a></li><li data-type='method'><a href="sop.html#.oForEach">oForEach</a></li><li data-type='method'><a href="sop.html#.oIndexOf">oIndexOf</a></li><li data-type='method'><a href="sop.html#.oKeys">oKeys</a></li><li data-type='method'><a href="sop.html#.oToQueryString">oToQueryString</a></li><li data-type='method'><a href="sop.html#.setValueByPath">setValueByPath</a></li><li data-type='method'><a href="sop.html#.sFormat">sFormat</a></li><li data-type='method'><a href="sop.html#.sToObject">sToObject</a></li><li data-type='method'><a href="sop.html#.type">type</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#define">define</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Template.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>define({
    name: 'sop.Template',
    init: function () {
        /**
         * Supports a php style template in javascript
         *
         * @memberof sop
         * @param strTpl {String} Template string
         * @param debug {Boolean} Flag of debug
         * @constructor
         */
        var Template = function (strTpl, debug) {
            this.strTpl = strTpl || '';
            this.cTpl = null;
            this.debug = debug || false;

            this.syntaxReg = /\{\{([^{}]+)\}\}/g;
        };

        Template._syntaxDict = {
            'if(.*):': new RegExp('^if(.*):$'),
            'else if(.*):': new RegExp('^else if(.*):$'),
            'else:': new RegExp('^else:$'),
            'endif;': new RegExp('^endif;$'),
            'for(.*):': new RegExp('^for(.*):$'),
            'endfor;': new RegExp('^endfor;$')
        };

        Template.prototype._getSyntax = function (str) {
            var syntaxDict = Template._syntaxDict;
            var ret = '';

            for (var p in syntaxDict) {
                if (syntaxDict.hasOwnProperty(p)) {
                    if (syntaxDict[p].test(str)) {
                        ret = p;
                        break;
                    }
                }
            }

            return ret;
        };

        Template.prototype._translateSyntax = function (str) {
            var that = this;

            return str.replace(this.syntaxReg, function (m, p1) {
                var syntax = that._getSyntax(p1.replace(/^\s*|\s*$/g, ''));
                var part1 = '';
                var isDefOutput = false;

                switch (syntax) {
                    case 'if(.*):':
                        part1 = p1.replace('):', '){');
                        break;
                    case 'else if(.*):':
                        part1 = p1.replace('else', '}else').replace('):', '){');
                        break;
                    case 'else:':
                        part1 = p1.replace('else', '}else').replace(':', '{');
                        break;
                    case 'endif;':
                        part1 = '}';
                        break;
                    case 'for(.*):':
                        part1 = p1.replace('):', '){');
                        break;
                    case 'endfor;':
                        part1 = '}';
                        break;
                    default :
                        part1 = p1;
                        if (part1.indexOf('=') == -1) {
                            isDefOutput = true;
                        }
                        break;
                }

                if (isDefOutput) {
                    return 'output += ' + part1 + ';';
                } else {
                    return part1;
                }
            });
        };

        Template.prototype._translateNormal = function (str) {
            return "output += '" + str.replace(/\r{0,1}\n/g, '').replace(/'/g, "\\'") + "';";
        };

        Template.prototype._makeFnContentBody = function (str) {
            if (this.syntaxReg.test(str)) {
                var matches, startIndex = 0, items = [], regex = this.syntaxReg, normal = '', syntax = '', len = str.length;
                regex.lastIndex = 0;

                while ((matches = regex.exec(str)) !== null &amp;&amp; startIndex &lt; len) {
                    normal = str.slice(startIndex, matches.index);
                    syntax = str.slice(matches.index, regex.lastIndex);

                    normal = this._translateNormal(normal);

                    /**
                     * in the invoking 'this._translateSyntax(syntax)' we use the function String.replace,
                     * it uses the same Regexp 'this.syntaxReg' as we are using here. after calling the String.replace, it
                     * will reset the lastIndex of the Regexp 'this.syntaxReg', so we need to save the lastIndex and reset it
                     * to before calling the String.replace
                     */
                    startIndex = regex.lastIndex;
                    syntax = this._translateSyntax(syntax);
                    regex.lastIndex = startIndex;

                    items.push(normal);
                    items.push(syntax);
                }

                if (startIndex > 0 &amp;&amp; startIndex &lt; len) {
                    normal = str.slice(startIndex, len);
                    normal = this._translateNormal(normal);
                    items.push(normal);
                }

                return items;
            }

            return [this._translateNormal(str)];
        };

        Template.prototype._process = function () {
            var fnContentHeader = 'context = context || {}; var output = \'\';';
            var fnContentBody = this._makeFnContentBody(this.strTpl).join('\n');
            var fnContentFooter = 'return output;';

            var fnContent = fnContentHeader + fnContentBody + fnContentFooter;

            if (this.debug) {
                console.log(fnContent);
            }

            var processed = new Function(['context'], fnContent);
            this.cTpl = new Template.CTpl(processed);
        };

        /**
         * Gets compiled template instance
         *
         * @returns {sop.Template.CTpl}
         */
        Template.prototype.getCTpl = function () {
            if (this.cTpl === null) {
                this._process();
            }

            return this.cTpl;
        };

        /**
         * Compiled template
         *
         * @param processed {Function} Compiled function
         * @constructor
         */
        Template.CTpl = function (processed) {
            this.processed = processed;
        };

        /**
         * Renders template with given context
         *
         * @memberof sop.Template.CTpl
         * @function sop.Template.CTpl.prototype.render
         * @param context {Object} Context within render
         * @returns {String} Rendered string
         */
        Template.CTpl.prototype.render = function (context) {
            return this.processed(context);
        };

        return Template;
    }
});
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0-dev</a> on Tue Apr 14 2015 02:59:57 GMT+0800 (CST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
